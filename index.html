<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE APPTV CENTRAL</title>
  <style>
    body { background-color: #868980; color: #3a4e6e; font-family: sans-serif; margin: 0; padding: 0; }
    header, main, footer { padding: 1rem; }
    #buscador { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: none; border-radius: 5px; }
    #canales-inferiores { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 0.5rem; padding: 1rem; background: #1e1f33; scroll-behavior: smooth; }
    .canal { background: #80f077; border-radius: 10px; padding: 0.5rem 1rem; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
    .canal:hover { background: #d4d4ea; }
    .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .player-container { position: relative; width: 100%; height: 30vh; background: #868980; }
    video, .player-container iframe { width: 100%; height: 100%; object-fit: cover; }
    .botones-panel { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    button { padding: 0.3rem 0.6rem; background:#5892bd; border: none; border-radius: 5px; color: white; cursor: pointer; }
    button:hover { background: #5892bd; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #ac2c2c; padding: 1rem; border-radius: 10px; width: 80%; max-height: 80%; overflow: auto; }
    #listaFavoritos { list-style: none; padding: 0; }
    #listaFavoritos li { padding: 0.5rem; border-bottom: 1px solid #eeeeee; display: flex; justify-content: space-between; align-items: center; }
    .paginacion { display: flex; justify-content: center; gap: 1rem; padding: 1rem; }
    .modal h3 { color: black; text-align: center; }
    .modal-content button { background: #d6d7dc; border: none; color: black; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
    .modal-content button:hover { background: #8fce00; }
    .flecha-carrusel { position: absolute; top: 50%; transform: translateY(-50%); font-size: 2rem; color: white; background: rgba(0, 0, 0, 0.5); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 10; }
    .flecha-izquierda { left: 5px; }
    .flecha-derecha { right: 5px; }
    #carrusel-wrapper { position: relative; }
    .fullscreen-iframe { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: black !important; }
    .fullscreen-iframe-button { position: fixed; top: 10px; right: 10px; z-index: 10000; background: #fff; color: #000; border: 2px solid #000; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .tab { padding:6px 10px; border:1px solid #444; border-radius:6px; cursor:pointer; background:#2b2b2b; color:#fff; }
    .tab.active { background:#333; }
    .grid-split { display:grid; gap:8px; width:100%; height:100%; }
    .site-select { max-width: 420px; width: 100%; }
    .site-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <!-- Google CSE (opcional) -->
  <script async src="https://cse.google.com/cse.js?cx=04f5ff6986fe641ad"></script>
  <div class="gcse-search"></div>

  <header>
    <h1>THE APPTV CENTRAL</h1>

    <div id="carrusel-wrapper">
      <button class="flecha-carrusel flecha-izquierda" onclick="scrollCarrusel(-1)">â¬…ï¸</button>
      <div id="canales-inferiores"></div>
      <button class="flecha-carrusel flecha-derecha" onclick="scrollCarrusel(1)">â¡ï¸</button>
    </div>

    <div id="youtube-controls" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
      <input id="youtubeSearch" type="text" placeholder="Buscar en YouTube..." style="flex: 1; padding: 0.5rem;" />
      <button onclick="buscarYT()">ğŸ” Buscar</button>
      <button onclick="toggleRotacion()">â¸ï¸ Pausar</button>
      <button onclick="siguienteVideo()">â­ï¸ Siguiente</button>
    </div>

    <input type="text" id="buscador" placeholder="Buscar canal..." />
    <input type="file" id="cargarArchivo" accept=".json,.m3u8,.m3u" />
    <button onclick="cargarCanalesInternos()">ğŸï¸ Cargar Canales Internos</button>
    <button onclick="mostrarFavoritos()">ğŸ“ Ver Favoritos</button>
    <button onclick="exportarFavoritos()">ğŸ’¾ Exportar Favoritos</button>
    <button onclick="desbloquearAdulto()">ğŸ”ğŸ”‘ Desbloquear Adultos</button>
  </header>

  <main>
    <div class="player-grid">
      <!-- MONITOR 1 -->
      <div>
        <div class="player-container" data-index="0"><video id="player1" controls></video></div>
        <div class="botones-panel">
          <button onclick="agregarAFavoritos(0)">â­ Guardar</button>
          <button onclick="iniciarAleatorio(0)">ğŸ² Aleatorio</button>
          <button onclick="detenerAleatorio(0)">â¹ï¸ Detener</button>
          <button onclick="reproducirDesdeBusqueda(0)">â–¶ï¸ YouTube</button>
        </div>
        <div class="botones-panel">
          <select id="siteSelect0" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode0" checked> Vista dividida (si hay varios)
            </label>
            <button onclick="cargarGraficoTV(0)">ğŸŒ Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(0)">ğŸ’¾ Guardar selecciÃ³n</button>
            <button onclick="limpiarSeleccionSitios(0)">ğŸ§¹ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput0" placeholder="SÃ­mbolo (ej: EURUSD)" style="flex: 1; padding: 0.5rem;" />
          <button onclick="cargarGraficoTV(0)">ğŸ“ˆ GrÃ¡fico</button>
          <button onclick="quitarGraficoTV(0)">ğŸ—‘ï¸ Quitar</button>
        </div>
      </div>

      <!-- MONITOR 2 -->
      <div>
        <div class="player-container" data-index="1"><video id="player2" controls></video></div>
        <div class="botones-panel">
          <button onclick="agregarAFavoritos(1)">â­ Guardar</button>
          <button onclick="iniciarAleatorio(1)">ğŸ² Aleatorio</button>
          <button onclick="detenerAleatorio(1)">â¹ï¸ Detener</button>
          <button onclick="reproducirDesdeBusqueda(1)">â–¶ï¸ YouTube</button>
        </div>
        <div class="botones-panel">
          <select id="siteSelect1" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode1" checked> Vista dividida (si hay varios)
            </label>
            <button onclick="cargarGraficoTV(1)">ğŸŒ Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(1)">ğŸ’¾ Guardar selecciÃ³n</button>
            <button onclick="limpiarSeleccionSitios(1)">ğŸ§¹ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput1" placeholder="SÃ­mbolo (ej: EURUSD)" style="flex: 1; padding: 0.5rem;" />
          <button onclick="cargarGraficoTV(1)">ğŸ“ˆ GrÃ¡fico</button>
          <button onclick="quitarGraficoTV(1)">ğŸ—‘ï¸ Quitar</button>
        </div>
      </div>

      <!-- MONITOR 3 -->
      <div>
        <div class="player-container" data-index="2"><video id="player3" controls></video></div>
        <div class="botones-panel">
          <button onclick="agregarAFavoritos(2)">â­ Guardar</button>
          <button onclick="iniciarAleatorio(2)">ğŸ² Aleatorio</button>
          <button onclick="detenerAleatorio(2)">â¹ï¸ Detener</button>
          <button onclick="reproducirDesdeBusqueda(2)">â–¶ï¸ YouTube</button>
        </div>
        <div class="botones-panel">
          <select id="siteSelect2" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode2" checked> Vista dividida (si hay varios)
            </label>
            <button onclick="cargarGraficoTV(2)">ğŸŒ Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(2)">ğŸ’¾ Guardar selecciÃ³n</button>
            <button onclick="limpiarSeleccionSitios(2)">ğŸ§¹ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput2" placeholder="SÃ­mbolo (ej: EURUSD)" style="flex: 1; padding: 0.5rem;" />
          <button onclick="cargarGraficoTV(2)">ğŸ“ˆ GrÃ¡fico</button>
          <button onclick="quitarGraficoTV(2)">ğŸ—‘ï¸ Quitar</button>
        </div>
      </div>

      <!-- MONITOR 4 -->
      <div>
        <div class="player-container" data-index="3"><video id="player4" controls></video></div>
        <div class="botones-panel">
          <button onclick="agregarAFavoritos(3)">â­ Guardar</button>
          <button onclick="iniciarAleatorio(3)">ğŸ² Aleatorio</button>
          <button onclick="detenerAleatorio(3)">â¹ï¸ Detener</button>
          <button onclick="reproducirDesdeBusqueda(3)">â–¶ï¸ YouTube</button>
        </div>
        <div class="botones-panel">
          <select id="siteSelect3" multiple size="5" class="site-select"></select>
          <div class="site-controls">
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="splitMode3" checked> Vista dividida (si hay varios)
            </label>
            <button onclick="cargarGraficoTV(3)">ğŸŒ Abrir sitios</button>
            <button onclick="guardarSeleccionSitios(3)">ğŸ’¾ Guardar selecciÃ³n</button>
            <button onclick="limpiarSeleccionSitios(3)">ğŸ§¹ Limpiar</button>
          </div>
        </div>
        <div class="botones-panel">
          <input type="text" id="symbolInput3" placeholder="SÃ­mbolo (ej: EURUSD)" style="flex: 1; padding: 0.5rem;" />
          <button onclick="cargarGraficoTV(3)">ğŸ“ˆ GrÃ¡fico</button>
          <button onclick="quitarGraficoTV(3)">ğŸ—‘ï¸ Quitar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modales -->
  <div class="modal" id="modalFavoritos">
    <div class="modal-content">
      <h3>ğŸ¯ Favoritos</h3>
      <ul id="listaFavoritos"></ul>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <div class="modal" id="modalPantalla">
    <div class="modal-content">
      <h3>ğŸ–¥ï¸ Â¿En quÃ© pantalla quieres ver este canal?</h3>
      <div style="display: flex; gap: 1rem; justify-content: center; margin: 1rem 0;">
        <button onclick="reproducirEnPantallaSeleccionada(0)">Pantalla 1</button>
        <button onclick="reproducirEnPantallaSeleccionada(1)">Pantalla 2</button>
        <button onclick="reproducirEnPantallaSeleccionada(2)">Pantalla 3</button>
        <button onclick="reproducirEnPantallaSeleccionada(3)">Pantalla 4</button>
      </div>
      <button onclick="cerrarModalPantalla()">Cancelar</button>
    </div>
  </div>

  <!-- LibrerÃ­a HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Evito conflictos: si tenÃ­as un main.js que tocaba lo mismo, mejor desactivarlo
  <script src="main.js"></script>
  -->

  <script>
    /* ================== HUD de estado ================== */
    const statusBox = document.createElement('div');
    statusBox.style.cssText = 'position:fixed;bottom:10px;left:10px;background:#111;color:#fff;padding:10px;border-radius:8px;font:12px/1.2 monospace;max-width:60vw;z-index:99999;opacity:.9';
    statusBox.innerHTML = 'M3U Loader: â€¦';
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(statusBox));
    const log = (...a)=>{console.log('[M3U]',...a); statusBox.innerHTML = (statusBox.innerHTML + '<br>' + a.map(String).join(' ')).slice(-4000);};

    /* ================== Carrusel ================== */
    function scrollCarrusel(direccion) {
      const carrusel = document.getElementById("canales-inferiores");
      const cantidad = 300 * direccion;
      carrusel.scrollBy({ left: cantidad, behavior: "smooth" });
    }

    /* ================== Parser M3U tolerante ================== */
    function parseM3U(text) {
      const clean = (text || '').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
      const lines = clean.split('\n');
      const out = [];
      for (let i=0;i<lines.length;i++) {
        const line = lines[i].trim();
        if (!line || line.startsWith('#EXTM3U')) continue;

        if (line.startsWith('#EXTINF')) {
          let name = 'Canal sin nombre';
          const commaIdx = line.indexOf(',');
          if (commaIdx !== -1 && commaIdx < line.length-1) {
            name = line.slice(commaIdx+1).trim() || name;
          }
          const url = (lines[i+1] || '').trim();
          if (url && /^https?:\/\//i.test(url)) {
            out.push({ nombre: name, url });
            i++;
          }
          continue;
        }
        if (/^https?:\/\//i.test(line)) {
          out.push({ nombre: line.split('/').slice(-1)[0] || 'Canal', url: line });
        }
      }
      return out;
    }

    /* ================== Render & estado ================== */
    let canalSeleccionado = null;
    let listaOriginalCanales = [];

    function mostrarCanales(canales, guardarOriginal = false) {
      if (guardarOriginal) listaOriginalCanales = canales;
      const contenedor = document.getElementById("canales-inferiores");
      contenedor.innerHTML = "";
      if (!canales.length) {
        contenedor.innerHTML = '<div class="canal" style="background:#f88;color:#000">No se cargaron canales</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      canales.forEach((canal) => {
        const div = document.createElement("div");
        div.className = "canal";
        div.textContent = canal.nombre || 'Canal';
        div.setAttribute('data-url', canal.url);
        frag.appendChild(div);
      });
      contenedor.appendChild(frag);
      log('âœ… Carrusel renderizado:', canales.length, 'canales');
    }

    // Click delegado carrusel
    document.getElementById('canales-inferiores').addEventListener('click', (e) => {
      const item = e.target.closest('.canal');
      if (!item) return;
      const url = item.getAttribute('data-url');
      if (!url) return;
      mostrarModalPantalla(url);
    });

    /* ================== Modal & reproducciÃ³n ================== */
    function mostrarModalPantalla(url) {
      canalSeleccionado = url;
      document.getElementById("modalPantalla").style.display = "flex";
    }
    function cerrarModalPantalla() {
      document.getElementById("modalPantalla").style.display = "none";
      canalSeleccionado = null;
    }
    function reproducirEnPantallaSeleccionada(pantallaIndex) {
      if (canalSeleccionado) {
        const container = document.querySelector(`.player-container[data-index='${pantallaIndex}']`);
        container.innerHTML = `<video id="player${pantallaIndex + 1}" controls></video>`;
        reproducirCanal(canalSeleccionado, pantallaIndex);
      }
      cerrarModalPantalla();
    }
    function reproducirCanal(url, playerIndex) {
      const player = document.getElementById(`player${playerIndex + 1}`);
      if (!player) return;
      if (player.hlsInstance) { try { player.hlsInstance.destroy(); } catch (e) {} }

      if (window.Hls && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        player.hlsInstance = hls;
        hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(()=>{}));
        hls.on(Hls.Events.ERROR, (e,data)=> log('HLS error', data?.type, data?.details || ''));
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
        player.addEventListener('loadedmetadata', () => player.play().catch(()=>{}), { once:true });
      } else {
        alert("Tu navegador no soporta la reproducciÃ³n de este canal.");
      }
    }

    /* ================== BÃºsqueda ================== */
    function filtrarCanales() {
      const texto = (document.getElementById("buscador").value || '').toLowerCase();
      const filtrados = listaOriginalCanales.filter(c => (c.nombre||'').toLowerCase().includes(texto));
      mostrarCanales(filtrados);
    }
    document.getElementById("buscador").addEventListener("input", filtrarCanales);

    /* ================== Carga manual (input file) ================== */
    document.getElementById('cargarArchivo').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const ext = file.name.split('.').pop().toLowerCase();
      const text = await file.text();

      if (ext === 'json') {
        try {
          const data = JSON.parse(text);
          if (Array.isArray(data)) {
            const canales = data.map(c => ({ nombre: c.nombre || c.name || 'Canal', url: c.url }));
            mostrarCanales(canales, true);
            log('ğŸ“¤ Cargado JSON con', canales.length, 'canales');
          } else {
            alert('JSON invÃ¡lido: debe ser un array de {nombre,url}');
          }
        } catch (err) {
          alert('Error al leer el JSON');
        }
      } else {
        const canales = parseM3U(text);
        mostrarCanales(canales, true);
        log('ğŸ“¤ Cargado M3U con', canales.length, 'canales');
      }
      e.target.value = '';
    });

    /* ================== Carga interna (botÃ³n) ================== */
    async function cargarCanalesInternos() { await loadM3UFiles(true); }

    /* ================== Auto-load de M3U ================== */
    const M3U_FILES = [
      // ğŸ”§ CAMBIA AQUÃ si tus archivos tienen otros nombres o carpetas
      'Country Colombia.m3u',
      'Country Bolivia.m3u',
      'Country Brazil.m3u',
    ];

    async function fetchTextSafe(path) {
      const url = encodeURI(path.trim());
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const txt = await res.text();
        log('ğŸ“¥ OK', url, `(${txt.length} bytes)`);
        return { ok:true, url, text:txt };
      } catch (err) {
        log('âŒ Fetch fail', url, String(err));
        return { ok:false, url, error: String(err) };
      }
    }

    async function loadM3UFiles(fromButton=false) {
      statusBox.innerHTML = fromButton ? 'Cargando listas (botÃ³n)â€¦' : 'Auto-cargando listasâ€¦';
      const results = await Promise.all(M3U_FILES.map(fetchTextSafe));

      const canales = [];
      let errores = 0;
      for (const r of results) {
        if (r.ok) {
          const parsed = parseM3U(r.text);
          log('ğŸ” Parse', r.url, 'â†’', parsed.length, 'canales');
          canales.push(...parsed);
        } else {
          errores++;
        }
      }

      if (!canales.length) {
        log('âš ï¸ Sin canales. DEMO fallback.');
        mostrarCanales([
          { nombre:'DEMO Canal HLS 1', url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
          { nombre:'DEMO Big Buck Bunny', url:'https://test-streams.mux.dev/bbb-abr/bbb.m3u8' },
        ], true);
        statusBox.innerHTML += '<br>âš ï¸ No se pudieron cargar tus .m3u. Revisa nombres/rutas y CORS.';
      } else {
        mostrarCanales(canales, true);
        statusBox.innerHTML += `<br>âœ… Cargados ${canales.length} canales (${errores} errores)`;
      }
    }

    /* ================== YouTube ================== */
    let apiKey = "AIzaSyA4NpwgJmEzBGGTzFFjShyrtWICgSSml-I";
    let rotationInterval = null;
    let currentVideoIndex = 0;
    let youtubeResults = [];
    let isPaused = false;

    function buscarYT() {
      const q = document.getElementById("youtubeSearch").value.trim();
      if (!q) return alert("Escribe una bÃºsqueda.");
      fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=40&q=${encodeURIComponent(q)}&key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          if (!data.items?.length) return alert("No se encontraron resultados.");
          youtubeResults = data.items;
          currentVideoIndex = 0;
          reproducirVideoActual();
          iniciarRotacion();
        })
        .catch(err => { console.error("Error YouTube:", err); alert("Error al buscar videos."); });
    }
    function reproducirVideoActual() {
      const video = youtubeResults[currentVideoIndex];
      if (!video) return;
      const videoId = video.id.videoId;
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0`;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      const container = document.querySelector(".player-container[data-index='0']");
      container.innerHTML = "";
      container.appendChild(iframe);
    }
    function iniciarRotacion() { detenerRotacion(); rotationInterval = setInterval(() => { if (!isPaused) siguienteVideo(); }, 3 * 60 * 1000); }
    function detenerRotacion() { if (rotationInterval) clearInterval(rotationInterval); }
    function toggleRotacion() { isPaused = !isPaused; alert(isPaused ? "â¸ï¸ RotaciÃ³n pausada." : "â–¶ï¸ RotaciÃ³n reanudada."); }
    function siguienteVideo() { currentVideoIndex = (currentVideoIndex + 1) % youtubeResults.length; reproducirVideoActual(); }

    /* ================== TradingView / sitios por monitor ================== */
    const FAVORITE_SITES = [
      { label: "Central App's", url: "https://cuervo-123.github.io/GLOBALTV4YOUPLUS/" },
      { label: "Global country Tv App", url: "https://cuervo-123.github.io/tv4you/" },
      { label: "Logo full acces app", url: "https://cuervo-123.github.io/mi-tv-station/" },
      { label: "4 monitors pro app", url: "https://cuervo-123.github.io/GLOBALTV4YOU/" },
      { label: "Karaoke app pro", url: "https://cuervo-123.github.io/Editor-iptv-Plus/" },
      { label: "Karaoke app pro", url: "https://cuervo-123.github.io/Editor-iptv-Plus/" },
      { label: "x app", url: "https://wap.tizam.club/fil_my_dlya_vzroslyh/podrostki_18/ryzhen_kie_ochen_seksual_ny_5/" },
      { label: "DJ App", url: "https://cuervo-123.github.io/GLOBALTV4YOUPLUS/" },
      { label: "All Functions pro", url: "https://cuervo-123.github.io/mi-tv-station-v-10.1/" },
      { label: "Add to search bar (Firefox)", url: "https://addons.mozilla.org/en-US/firefox/addon/add-to-search-bar/" }
    ];
    const LS_KEY = (idx) => `siteSelection:${idx}`;
    const normalizeUrl = (u) => { if (!u) return ""; let url = u.trim(); if (!/^https?:\/\//i.test(url)) url = "https://" + url.replace(/^\/+/, ""); return url; };

    function initSitePicker(index) {
      const select = document.getElementById(`siteSelect${index}`);
      if (!select) return;
      select.innerHTML = FAVORITE_SITES.map(s => `<option value="${s.url}">${s.label} â€” ${s.url}</option>`).join("");
      const saved = JSON.parse(localStorage.getItem(LS_KEY(index)) || "[]");
      Array.from(select.options).forEach(opt => { if (saved.includes(opt.value)) opt.selected = true; });
    }
    function guardarSeleccionSitios(index) {
      const select = document.getElementById(`siteSelect${index}`);
      const seleccion = Array.from(select.selectedOptions).map(o => o.value);
      localStorage.setItem(LS_KEY(index), JSON.stringify(seleccion));
      alert("SelecciÃ³n guardada âœ…");
    }
    function limpiarSeleccionSitios(index) {
      const select = document.getElementById(`siteSelect${index}`);
      Array.from(select.options).forEach(o => (o.selected = false));
      localStorage.removeItem(LS_KEY(index));
    }
    function renderIframesInContainer(index, urls) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      if (!container) return;
      const cleanUrls = urls.map(normalizeUrl).filter(Boolean);
      if (!cleanUrls.length) return alert("Selecciona al menos 1 sitio.");
      const split = document.getElementById(`splitMode${index}`)?.checked && cleanUrls.length > 1;

      if (split) {
        const n = cleanUrls.length;
        let cols = 2; if (n === 3) cols = 3; if (n >= 4) cols = 3;
        const gridStyle = `grid-template-columns: repeat(${cols}, 1fr); grid-auto-rows: minmax(200px, 1fr);`;
        container.innerHTML = `<div class="grid-split" style="${gridStyle}; width:100%; height:100%;">${cleanUrls.map(u => `
          <iframe src="${u}" style="width:100%; height:100%; border:0;" frameborder="0" scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>`).join("")}
        </div>`;
      } else if (cleanUrls.length === 1) {
        container.innerHTML = `<iframe id="iframe-${index}-0" src="${cleanUrls[0]}" style="width:100%; height:100%; border:0;" frameborder="0" scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>`;
      } else {
        const tabs = cleanUrls.map((u, i) => `<button class="tab ${i===0?'active':''}" data-tab="${i}" onclick="activarTab(${index}, ${i})">${new URL(u).hostname}</button>`).join("");
        const iframes = cleanUrls.map((u, i) => `<iframe id="iframe-${index}-${i}" src="${u}" style="width:100%; height:calc(100% - 46px); border:0; display:${i===0?'block':'none'};" frameborder="0" scrolling="auto" allow="fullscreen; clipboard-read; clipboard-write"></iframe>`).join("");
        container.innerHTML = `<div class="tabs" id="tabs-${index}">${tabs}</div><div style="width:100%; height:calc(100% - 46px);">${iframes}</div>`;
      }
    }
    function activarTab(index, i) {
      const tabsWrap = document.getElementById(`tabs-${index}`); if (!tabsWrap) return;
      tabsWrap.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      const target = tabsWrap.querySelector(`.tab[data-tab='${i}']`); if (target) target.classList.add("active");
      const container = document.querySelector(`.player-container[data-index='${index}']`); if (!container) return;
      container.querySelectorAll("iframe[id^='iframe-']").forEach((f, idx) => { f.style.display = (idx === i) ? "block" : "none"; });
    }
    function cargarGraficoTV(index) {
      const select = document.getElementById(`siteSelect${index}`);
      const seleccion = select ? Array.from(select.selectedOptions).map(o => o.value) : [];
      const urls = (seleccion.length > 0) ? seleccion : ["https://cuervo-123.github.io/GLOBALTV4YOUPLUS/"];
      renderIframesInContainer(index, urls);
    }
    function quitarGraficoTV(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      container.innerHTML = `<video id="player${index + 1}" controls></video>`;
    }
    function toggleFullscreenGrafico(index) {
      const container = document.querySelector(`.player-container[data-index='${index}']`);
      const iframe = container.querySelector('iframe');
      if (!iframe) return alert("No hay grÃ¡fico para esta pantalla.");
      const isFullscreen = iframe.classList.toggle("fullscreen-iframe");
      const boton = document.getElementById(`btnFullscreen${index}`);
      if (boton) boton.textContent = isFullscreen ? "âŒ Salir de Fullscreen" : "ğŸ” Fullscreen";
      let botonSalir = document.getElementById(`btnExitFullscreen${index}`);
      if (isFullscreen) {
        if (!botonSalir) {
          botonSalir = document.createElement("button");
          botonSalir.id = `btnExitFullscreen${index}`;
          botonSalir.textContent = "âŒ Salir de Fullscreen";
          botonSalir.className = "fullscreen-iframe-button";
          botonSalir.onclick = () => toggleFullscreenGrafico(index);
          document.body.appendChild(botonSalir);
        }
      } else { if (botonSalir) botonSalir.remove(); }
    }

    /* ================== INIT ================== */
    document.addEventListener("DOMContentLoaded", () => {
      [0,1,2,3].forEach(initSitePicker);   // TradingView pickers
      loadM3UFiles(false);                 // Auto-load M3U al inicio

      // Botones Fullscreen para cada monitor (se agregan a su panel de grÃ¡ficos)
      for (let i = 0; i < 4; i++) {
        const paneles = document.querySelectorAll(".botones-panel")[i * 3 + 2];
        if (paneles) {
          const botonFull = document.createElement("button");
          botonFull.textContent = "ğŸ” Fullscreen";
          botonFull.id = `btnFullscreen${i}`;
          botonFull.onclick = () => toggleFullscreenGrafico(i);
          paneles.appendChild(botonFull);
        }
      }
    });

    /* ================== Placeholders de favoritos (tu lÃ³gica original) ================== */
    function agregarAFavoritos(idx){ alert('Favoritos: implementar segÃºn tu estructura de datos.'); }
    function iniciarAleatorio(idx){ alert('Aleatorio: implementar segÃºn tu lÃ³gica.'); }
    function detenerAleatorio(idx){ alert('Detener aleatorio: implementar.'); }
    function reproducirDesdeBusqueda(idx){ alert('YouTube por monitor: adaptar si quieres bÃºsquedas por monitor.'); }
    function mostrarFavoritos(){ document.getElementById('modalFavoritos').style.display='flex'; }
    function cerrarModal(){ document.getElementById('modalFavoritos').style.display='none'; }
    function exportarFavoritos(){ alert('Exportar favoritos: implementar segÃºn tu formato.'); }
    function desbloquearAdulto(){ alert('Adultos: implementar PIN/clave.'); }
  </script>
</body>
</html>
